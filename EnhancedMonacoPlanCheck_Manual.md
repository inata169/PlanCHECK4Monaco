# EnhancedMonacoPlanCheck 仕様書

# EnhancedMonacoPlanCheck 仕様書  2025/3/4

**1. はじめに**

このドキュメントは、Monaco Scripting APIを使用して放射線治療計画の詳細な検証を行うC#スクリプト (EnhancedMonacoPlanCheck) の仕様を記述したものです。このスクリプトは、治療計画の品質管理と安全性確保を目的としており、治療計画パラメータの検証を自動化することで、ヒューマンエラーを防止し、治療の質を向上させます。

**2. スクリプトの概要**

EnhancedMonacoPlanCheck スクリプトは、Elekta Monaco治療計画システムでアクティブな治療計画を解析し、以下のカテゴリに関する多様なチェックを実施します:

- **患者基本情報**: 患者ID、患者名、クリニック名
- **プラン情報**: プランIDの形式検証
- **処方情報**: 処方線量、分割線量、最大線量比
- **ビーム設定**: アイソセンター一貫性、フィールドID形式、最小MU値など
- **ジオメトリ設定**: ガントリ角、コリメータ角、カウチ角、アーク方向など
- **コリメータ設定**: 照射野サイズ
- **治療補助具**: カウチ、ボーラス、ウェッジなど
- **DVH統計情報**: PTVに対する適合度指数(CI)、不均一性指数(HI)
- **計算設定**: 線量計算アルゴリズム、グリッド間隔、最大粒子数など

チェック結果は直感的なユーザーインターフェースに表示され、重要度別に色分けされます。また、結果は整形されたテキストファイルとしてデスクトップの専用フォルダに保存されます。

**3. 機能詳細**

**3.1 チェック項目**

| **カテゴリ** | **項目** | **説明** | **判定基準** |
| --- | --- | --- | --- |
| 患者 | 患者ID | 治療計画の患者ID | 取得できること |
|  | 患者名 | 治療計画の患者名 | 取得できること |
|  | クリニック | 治療計画のクリニック名 | 取得できること |
| プラン | プランID形式 | プランIDの命名規則 | `(3D|VMAT|DCAT)` + 3桁の数字の形式であること |
| 処方 | 処方線量 | プランに設定された処方線量 | 1 cGy以上であること |
|  | 分割線量 | 1分割あたりの線量 | 1 cGy以上であること |
|  | 最大線量比 | プラン中の最大線量/処方線量 | 1.17以下であること |
| ビーム | アイソセンター一貫性 | 全ビームのアイソセンター位置 | 全ビームで同じアイソセンターを使用していること |
|  | フィールドID形式 | 各ビームのフィールドID | 数字4桁の形式であること |
|  | 最小MU | 各ビームのモニターユニット値 | 10.0 MU以上であること |
|  | 計算アルゴリズム | 各ビームの線量計算アルゴリズム | 取得できること |
|  | エネルギー | 各ビームのエネルギー値 | 取得できること |
|  | アイソセンター位置 | 各ビームのアイソセンター座標 | 取得できること（PTVの中心であることが望ましい） |
| ジオメトリ | 角度 | 各ビームのガントリ角、コリメータ角、カウチ角 | 取得できること |
|  | アーク方向 | アークビームの回転方向（CW/CCW） | アーク治療の場合、取得できること |
|  | アーク長 | アークビームの回転角度 | アーク治療の場合、取得できること |
| コリメータ | コリメータ詳細 | 各ビームのコリメータ設定（Width1, Width2, Length1, Length2） | Width1 + Width2 > 3.0 cm かつ Length1 + Length2 > 3.0 cm |
| 治療補助具 | カウチ有効化 | 各ビームでのカウチモデル使用状態 | 有効（True）であること |
|  | ボーラス | 各ビームで使用されるボーラス | 取得できること |
|  | ウェッジID | 各ビームで使用されるウェッジ | 設定されている場合、取得できること |
| DVH統計 | CI | PTVの適合度指数 | 取得できること |
|  | HI | PTVの不均一性指数 | 取得できること |
| 計算設定 | 線量計算アルゴリズム | 線量計算に使用されるアルゴリズム | 取得できること |
|  | 最終計算アルゴリズム | 最終線量計算アルゴリズム | 取得できること |
|  | グリッド間隔 | 計算グリッドのサイズ | 0.1から0.8の範囲内であること |
|  | ビームあたりの最大粒子数 | 線量計算で使用される最大粒子数 | 設定されていること |

**3.2 出力形式**

- **グラフィカルユーザーインターフェース（GUI）**
    - DataGridViewを使用したチェック結果の表形式表示
    - 重要度に応じた行の色分け（エラー：ピンク、警告：黄色、情報：白）
    - 項目の分類（カテゴリ）、詳細項目名、合否結果、実際値、期待値、重要度の列表示
    - 画面下部にチェック結果の要約（エラー数、警告数、情報数）を表示
- **テキストファイル出力**
    - 出力先：デスクトップ > MonacoPlanCheck フォルダ
    - ファイル命名規則：`PlanCheck_{患者ID}_{患者名}_{プランID}_{タイムスタンプ}.txt`
    - 見やすく整形された表形式の出力
    - カテゴリ別にグループ化
    - 合否結果を視覚的なマーク（?、?）で表示
    - エラー、警告にはそれぞれ[E]、[W]のマークを付加
    - 概要情報をファイル冒頭に表示
    - 生成日時を記録

**3.3 処理フロー**

1. MonacoアプリケーションとAPIの初期化
2. 現在の患者情報と治療計画の取得
3. 以下の項目についてチェックを実施:
    - 基本プラン情報の検証
    - 処方と線量情報の検証
    - ビームプロパティの検証
    - DVH統計情報の解析
    - 計算設定の確認
4. チェック結果をGUIに表示
5. チェック結果をテキストファイルに保存
6. 完了メッセージの表示

**4. 技術仕様**

- **プログラミング言語**: C#
- **フレームワーク**: .NET Framework（Windows Forms）
- **API**: Elekta Monaco Scripting API
    - 主要利用クラス:
        - MonacoApplication
        - BeamsSpreadsheet
        - DVHStatisticsSpreadsheet
        - CalculationPropertiesSettings
    - 利用名前空間:
        - Elekta.MonacoScripting.API
        - Elekta.MonacoScripting.API.General
        - Elekta.MonacoScripting.API.Planning
        - Elekta.MonacoScripting.API.Beams
        - Elekta.MonacoScripting.DataType

**5. クラス構造**

- **PlanCheckResult**: チェック結果を格納するデータクラス
    - 属性:
        - Category: チェックカテゴリ
        - Item: チェック項目
        - Pass: 合否フラグ
        - ActualValue: 実際の値
        - ExpectedValue: 期待値
        - Severity: 重要度（エラー、警告、情報）
- **ResultForm**: 結果表示用のGUIフォームクラス
    - 主要コンポーネント:
        - DataGridView: チェック結果の表形式表示
        - Label: 結果概要の表示
    - 主要メソッド:
        - DisplayResults: チェック結果を表示し、重要度に応じて行を色分け
- **Program**: メインロジッククラス
    - 定数:
        - MIN_MU: 最小モニターユニット値（10.0）
        - MIN_DOSE: 最小線量値（1.0 cGy）
        - MAX_DOSE_RATIO: 最大許容線量比（1.17）
        - MIN_COLLIMATOR_SIZE: 最小コリメータサイズ（3.0 cm）
    - 主要メソッド:
        - CheckBasicPlanInfo: 基本的なプラン情報をチェック
        - CheckPrescriptionAndDose: 処方と線量情報をチェック
        - CheckBeamProperties: ビームプロパティをチェック
        - CheckDVHStatistics: DVH統計情報をチェック
        - CheckCalculationSettings: 計算設定をチェック
        - SaveResultsToFile: 結果をテキストファイルに保存
        - ConvertToTable: チェック結果をテキスト形式に変換

**6. エラー処理**

- try-catch構文による例外処理
- ログ管理（Logger.Instance使用）
- ユーザーへのエラー通知（MessageBox）
- エラー詳細のログファイル記録

**7. 制約条件と留意事項**

- Monaco治療計画システムが実行環境でインストールされ、アクティブであること
- 特定のMonacoバージョンにAPIが依存する可能性があるため、バージョンの互換性に注意
- 十分な権限を持つユーザーアカウントでの実行が必要
- 結果保存先（デスクトップ > MonacoPlanCheck）への書き込み権限が必要

**8. 今後の拡張可能性**

- 施設固有の許容値設定のカスタマイズ機能
- 追加チェック項目の実装（オーガン、障害リスクなど）
- 結果出力形式の拡張（PDF、Excel、データベース連携など）
- 治療計画間の比較機能
- 高度な統計解析機能の追加
- 他の放射線治療計画システムとの互換性拡張
- ネットワーク共有またはクラウドストレージへの結果保存オプション

**9. 結論**

EnhancedMonacoPlanCheckスクリプトは、放射線治療計画の品質保証プロセスを効率化し、治療計画の安全性と正確性を高めるための強力なツールです。視覚的に理解しやすいインターフェースと詳細なテキストレポートにより、プランのレビュープロセスをサポートし、患者の安全性向上に貢献します。
